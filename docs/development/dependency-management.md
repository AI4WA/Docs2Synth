# Dependency Management

This guide explains how dependencies are managed in the Docs2Synth project using modern best practices.

## Overview

Docs2Synth uses a layered dependency management approach with `uv` and lockfiles for fast, reproducible builds.

### Key Tools

- **[uv](https://github.com/astral-sh/uv)**: Ultra-fast Python package installer (10-100x faster than pip)
- **pyproject.toml**: Core dependencies (PEP 621 standard)
- **Lockfiles**: Exact version pinning for reproducibility

## File Structure

### Source Files (Edit These)

| File | Purpose | When to Edit |
|------|---------|--------------|
| `pyproject.toml` | Core project dependencies | Adding/updating core packages |
| `requirements-cpu.in` | PyTorch CPU specification | Changing PyTorch CPU version |
| `requirements-gpu.in` | PyTorch GPU specification | Changing PyTorch GPU version |
| `requirements-dev.in` | Development tools | Adding dev/test tools |

### Generated Lockfiles (Auto-generated)

| File | Purpose | Generated From |
|------|---------|----------------|
| `requirements-cpu.txt` | Locked CPU dependencies | `requirements-cpu.in` |
| `requirements-gpu.txt` | Locked GPU dependencies | `requirements-gpu.in` |
| `requirements-dev.txt` | Locked dev dependencies | `requirements-dev.in` |

!!! warning "Do Not Edit Lockfiles Manually"
    The `.txt` files are automatically generated by `uv pip compile`. Edit the corresponding `.in` file or `pyproject.toml` instead.

## Common Tasks

### Installing Dependencies

```bash
# Activate your virtual environment
source .venv/bin/activate

# For CPU development
uv pip install -r requirements-cpu.txt
uv pip install -e ".[dev]"

# For GPU development
uv pip install -r requirements-gpu.txt
uv pip install -e ".[dev]"
```

### Adding a Core Dependency

1. Edit `pyproject.toml`:

```toml
dependencies = [
    "click>=8.0",
    "new-package>=1.0.0",  # Add your package here
]
```

2. Reinstall the package:

```bash
uv pip install -e ".[dev]"
```

### Adding a Development Dependency

Development dependencies can be added in two places depending on their use:

**For dependencies needed by tests or all developers:**

1. Edit `pyproject.toml` under `[project.optional-dependencies]` â†’ `dev`:

```toml
dev = [
    "pytest>=7.0",
    "new-dev-tool>=2.0",  # Add your tool here
]
```

2. Reinstall the package:

```bash
uv pip install -e ".[dev]"
```

**For dependencies that should be locked in requirements-dev.txt:**

1. Also add to `requirements-dev.in`:

```text
pytest>=7.0
new-dev-tool>=2.0  # Add your tool here
```

2. Regenerate the lockfile:

```bash
uv pip compile requirements-dev.in -o requirements-dev.txt
```

!!! note "Sync pyproject.toml and requirements-dev.in"
    For consistency, keep `pyproject.toml` dev dependencies and `requirements-dev.in` in sync. The lockfile approach ensures reproducible builds in CI/CD.

### Updating Dependencies

#### Update All to Latest Compatible Versions

```bash
# Update CPU PyTorch dependencies
uv pip compile requirements-cpu.in -o requirements-cpu.txt --upgrade

# Update GPU PyTorch dependencies (requires Linux target)
uv pip compile requirements-gpu.in -o requirements-gpu.txt \
  --upgrade --python-version 3.11 --python-platform linux

# Update dev dependencies
uv pip compile requirements-dev.in -o requirements-dev.txt --upgrade
```

#### Update a Specific Package

1. Edit the version constraint in the appropriate `.in` file:

```text
# Before
pytest>=7.0

# After
pytest>=8.0
```

2. Regenerate the lockfile:

```bash
uv pip compile requirements-dev.in -o requirements-dev.txt
```

3. Install and test:

```bash
uv pip install -r requirements-dev.txt
pytest  # Verify everything works
```

## Why This Approach?

### Benefits

âœ… **Fast**: 10-100x faster than pip
âœ… **Reproducible**: Lockfiles ensure identical builds
âœ… **Maintainable**: Only edit high-level `.in` files
âœ… **Flexible**: Separate scenarios for CPU/GPU/dev
âœ… **Standards-based**: Uses PEP 621 `pyproject.toml`
âœ… **Compatible**: Works with pip and other tools

### Comparison with Alternatives

| Approach | Speed | Lockfiles | Standards | Complexity |
|----------|-------|-----------|-----------|------------|
| **uv + .in files** | âš¡âš¡âš¡ | âœ… | âœ… PEP 621 | Low |
| pip + requirements.txt | ðŸŒ | âŒ | âš ï¸ | Low |
| Poetry | âš¡ | âœ… | âš ï¸ Custom | Medium |
| Pipenv | âš¡ | âœ… | âš ï¸ Custom | Medium |

## Advanced Usage

### Testing Against Latest Dependencies

To test if the project works with the latest compatible versions:

```bash
# Compile with --upgrade to get latest versions
uv pip compile requirements-cpu.in -o requirements-cpu-latest.txt --upgrade
uv pip compile requirements-dev.in -o requirements-dev-latest.txt --upgrade

# Test in a clean environment
uv venv test-env
source test-env/bin/activate
uv pip install -r requirements-cpu-latest.txt
uv pip install -r requirements-dev-latest.txt
uv pip install -e .
pytest
```

### Platform-Specific Compilation

GPU builds require specifying the target platform:

```bash
# For Linux x86_64 with Python 3.10
uv pip compile requirements-gpu.in -o requirements-gpu.txt \
  --python-version 3.11 \
  --python-platform linux

# For Linux x86_64 with Python 3.11
uv pip compile requirements-gpu.in -o requirements-gpu.txt \
  --python-version 3.11 \
  --python-platform linux
```

### Inspecting Dependencies

```bash
# Show dependency tree
uv pip tree

# Check for outdated packages
uv pip list --outdated

# Show package details
uv pip show torch
```

## Troubleshooting

### "Could not find a version that satisfies..."

**Cause**: Version constraints are incompatible or package not available.

**Solution**:
1. Check version constraints in `.in` files and `pyproject.toml`
2. Relax overly strict version pins
3. Verify package availability for your platform/Python version

```bash
# Use verbose mode for details
uv pip compile requirements-dev.in -o requirements-dev.txt --verbose
```

### GPU Compilation Fails on macOS

**Cause**: CUDA packages are only available for Linux/Windows x86_64.

**Solution**: Specify target platform:

```bash
uv pip compile requirements-gpu.in -o requirements-gpu.txt \
  --python-version 3.11 --python-platform linux
```

### Lockfile Conflicts After Merge

**Cause**: Multiple developers updated dependencies differently.

**Solution**: Regenerate lockfiles from source:

```bash
# Regenerate all lockfiles
uv pip compile requirements-cpu.in -o requirements-cpu.txt
uv pip compile requirements-gpu.in -o requirements-gpu.txt --python-version 3.11 --python-platform linux
uv pip compile requirements-dev.in -o requirements-dev.txt

# Test the changes
uv pip install -r requirements-cpu.txt
uv pip install -e ".[dev]"
pytest
```

## Best Practices

### 1. Always Commit Lockfiles

Lockfiles ensure reproducibility across environments:

```bash
git add requirements-*.txt
git commit -m "Update dependencies"
```

### 2. Update Lockfiles Regularly

Keep dependencies secure and up-to-date:

```bash
# Weekly/monthly: update to latest compatible versions
uv pip compile requirements-cpu.in -o requirements-cpu.txt --upgrade
uv pip compile requirements-dev.in -o requirements-dev.txt --upgrade

# Test thoroughly
pytest
```

### 3. Test Before Committing

Always verify changes work:

```bash
# Run full test suite
pytest

# Check code quality
black --check .
isort --check .
flake8 .
```

### 4. Document Version Pins

If you pin to a specific version, add a comment explaining why:

```text
# requirements-dev.in
black==24.8.0  # Pinned: team uses this version for consistent formatting
pytest>=8.0    # Flexible: allow patch updates
```

### 5. Review Lockfile Diffs

When updating dependencies, review what changed:

```bash
git diff requirements-cpu.txt
```

Look for:
- Major version bumps (may have breaking changes)
- New dependencies (transitive deps)
- Removed dependencies

## CI/CD Integration

### GitHub Actions Example

```yaml
- name: Install uv
  uses: astral-sh/setup-uv@v5

- name: Cache uv packages
  uses: actions/cache@v3
  with:
    path: ~/.cache/uv
    key: ${{ runner.os }}-uv-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}

- name: Install dependencies
  run: |
    uv pip install --system -r requirements-cpu.txt
    uv pip install --system -e ".[dev]"
```

## Migration from Old Setup

If you're updating from the old `requirements.txt` approach:

1. **Pull latest changes**: `git pull`
2. **Remove old venv**: `rm -rf .venv`
3. **Install uv**: `curl -LsSf https://astral.sh/uv/install.sh | sh`
4. **Run setup**: `./setup.sh`

See [MIGRATION_SUMMARY.md](https://github.com/AI4WA/Docs2Synth/blob/main/MIGRATION_SUMMARY.md) for details.

## References

- [uv documentation](https://github.com/astral-sh/uv)
- [PEP 621 - Project metadata in pyproject.toml](https://peps.python.org/pep-0621/)
- [PyPA Packaging Guide](https://packaging.python.org/)
- [Python Packaging User Guide](https://packaging.python.org/en/latest/)
